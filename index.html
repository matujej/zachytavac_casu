<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Zachytávač času</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Zachytávač">
<meta name="theme-color" content="#0a0a0a">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  input { -webkit-user-select: text; user-select: text; }

  :root {
    --bg: #0a0a0a;
    --surface: #141414;
    --surface2: #1e1e1e;
    --border: #2a2a2a;
    --text: #e0e0e0;
    --text-dim: #666;
    --accent: #4ade80;
    --accent-dim: #22543d;
    --red: #f87171;
    --red-dim: #7f1d1d;
    --mono: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
  }

  body {
    font-family: var(--mono);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    min-height: 100dvh;
    padding: 24px;
    padding-top: calc(24px + env(safe-area-inset-top));
    padding-bottom: calc(24px + env(safe-area-inset-bottom));
    padding-left: calc(24px + env(safe-area-inset-left));
    padding-right: calc(24px + env(safe-area-inset-right));
    -webkit-user-select: none;
    user-select: none;
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 48px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  h1 {
    font-size: 14px;
    font-weight: 400;
    letter-spacing: 4px;
    text-transform: uppercase;
    color: var(--text-dim);
  }

  h1 span { color: var(--accent); }

  .btn {
    font-family: var(--mono);
    font-size: 11px;
    padding: 6px 12px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text);
    cursor: pointer;
    letter-spacing: 1px;
    text-transform: uppercase;
    transition: all 0.15s;
  }

  .btn:hover { border-color: var(--text-dim); background: var(--surface2); }
  .btn--accent { border-color: var(--accent-dim); color: var(--accent); }
  .btn--accent:hover { border-color: var(--accent); background: var(--accent-dim); }
  .btn--red { border-color: var(--red-dim); color: var(--red); }
  .btn--red:hover { border-color: var(--red); background: var(--red-dim); }
  .btn--small { padding: 3px 8px; font-size: 10px; }

  /* Projects grid */
  #projects { display: flex; flex-direction: column; gap: 12px; }

  .project {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 16px 20px;
  }

  .project--active { border-color: var(--accent-dim); }

  .project-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .project-name {
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 1px;
    cursor: pointer;
  }

  .project-name:hover { color: var(--accent); }

  .project-name-input {
    font-family: var(--mono);
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 1px;
    background: var(--bg);
    border: 1px solid var(--accent-dim);
    color: var(--text);
    padding: 2px 6px;
    outline: none;
  }

  .project-name-input:focus { border-color: var(--accent); }

  .project-controls { display: flex; gap: 6px; align-items: center; }

  .project-timer {
    display: flex;
    align-items: baseline;
    gap: 16px;
    margin-bottom: 12px;
  }

  .timer-display {
    font-size: 28px;
    font-weight: 300;
    letter-spacing: 2px;
    font-variant-numeric: tabular-nums;
  }

  .timer-total {
    font-size: 11px;
    color: var(--text-dim);
  }

  .timer-total span { color: var(--text); }

  .project-actions { display: flex; gap: 6px; }

  /* Entries */
  .entries {
    margin-top: 12px;
    border-top: 1px solid var(--border);
    padding-top: 10px;
  }

  .entries-toggle {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text-dim);
    background: none;
    border: none;
    cursor: pointer;
    letter-spacing: 1px;
    text-transform: uppercase;
    padding: 0;
  }

  .entries-toggle:hover { color: var(--text); }

  .entries-list {
    margin-top: 8px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .entry {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
    color: var(--text-dim);
    padding: 4px 0;
  }

  .entry-time { color: var(--text); }

  .entry .btn--small { opacity: 0; transition: opacity 0.15s; }
  .entry:hover .btn--small { opacity: 1; }

  /* Add manual entry form */
  .manual-form {
    display: flex;
    gap: 6px;
    align-items: center;
    margin-top: 8px;
  }

  .manual-form input {
    font-family: var(--mono);
    font-size: 11px;
    padding: 4px 8px;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text);
    width: 60px;
    text-align: center;
  }

  .manual-form input:focus { outline: none; border-color: var(--text-dim); }

  .manual-form label {
    font-size: 10px;
    color: var(--text-dim);
  }

  /* New project form */
  #new-project-form {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  #new-project-form input {
    font-family: var(--mono);
    font-size: 12px;
    padding: 6px 12px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text);
    flex: 1;
    max-width: 300px;
  }

  #new-project-form input:focus { outline: none; border-color: var(--text-dim); }

  .status-dot {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--accent);
    margin-right: 8px;
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* Backup footer */
  .backup-bar {
    margin-top: 48px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 8px;
    justify-content: center;
  }

  .backup-bar .btn { font-size: 10px; color: var(--text-dim); }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-dim);
    font-size: 12px;
    letter-spacing: 1px;
  }

  /* Mobile — iPhone 13 mini = 375px */
  @media (max-width: 480px) {
    body {
      padding: 16px;
      padding-top: calc(16px + env(safe-area-inset-top));
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      padding-left: calc(12px + env(safe-area-inset-left));
      padding-right: calc(12px + env(safe-area-inset-right));
    }

    header {
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 64px;
      padding-bottom: 40px;
    }

    h1 { font-size: 22px; letter-spacing: 3px; }

    #new-project-form {
      width: 100%;
    }

    #new-project-form input {
      max-width: none;
      min-width: 0;
      font-size: 14px;
      padding: 10px 12px;
    }

    #new-project-form .btn {
      font-size: 13px;
      padding: 10px 14px;
    }

    .project { padding: 14px 16px; }

    .project-name { font-size: 17px; }

    .project-timer {
      flex-direction: column;
      gap: 2px;
      margin-bottom: 16px;
    }

    .timer-display { font-size: 36px; }

    .timer-total { font-size: 12px; }

    .project-actions {
      flex-wrap: wrap;
      gap: 8px;
    }

    .project-actions .btn {
      flex: 1;
      text-align: center;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
    }

    .project-controls .btn--small {
      font-size: 11px;
      padding: 5px 10px;
    }

    .entry {
      flex-wrap: wrap;
      gap: 4px;
      padding: 6px 0;
    }

    .entry .btn--small { opacity: 1; padding: 4px 10px; }

    .manual-form {
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .manual-form input {
      width: 55px;
      font-size: 14px;
      padding: 8px;
    }

    .manual-form .btn {
      font-size: 12px;
      padding: 8px 12px;
    }

    .manual-form label { font-size: 14px; }
  }
</style>
</head>
<body>

<header>
  <h1>zachytávač <span>času</span></h1>
  <form id="new-project-form">
    <input type="text" id="project-name-input" placeholder="název projektu" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
    <button type="submit" class="btn btn--accent">+ projekt</button>
  </form>
</header>

<div id="projects"></div>

<div class="backup-bar">
  <button class="btn" onclick="exportData()">↓ export zálohy</button>
  <button class="btn" onclick="document.getElementById('import-file').click()">↑ import zálohy</button>
  <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(this)" />
</div>

<script>
const STORAGE_KEY = 'stylo-toddl-data';

let state = loadState();
let timerIntervals = {};

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : { projects: [] };
  } catch { return { projects: [] }; }
}

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function formatDuration(ms) {
  if (ms < 0) ms = 0;
  const s = Math.floor(ms / 1000);
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const sec = s % 60;
  return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
}

function totalTime(project) {
  let total = 0;
  for (const entry of project.entries) {
    total += entry.duration;
  }
  if (project.running && project.startedAt) {
    total += Date.now() - project.startedAt;
  }
  return total;
}

function currentSessionTime(project) {
  if (!project.running || !project.startedAt) return 0;
  return Date.now() - project.startedAt;
}

function startTimer(projectId) {
  const project = state.projects.find(p => p.id === projectId);
  if (!project || project.running) return;
  project.running = true;
  project.startedAt = Date.now();
  save();
  render();
}

function stopTimer(projectId) {
  const project = state.projects.find(p => p.id === projectId);
  if (!project || !project.running) return;
  const duration = Date.now() - project.startedAt;
  project.entries.push({
    id: Date.now(),
    start: project.startedAt,
    end: Date.now(),
    duration
  });
  project.running = false;
  project.startedAt = null;
  save();
  render();
}

function addManualEntry(projectId, hours, minutes) {
  const project = state.projects.find(p => p.id === projectId);
  if (!project) return;
  const h = parseInt(hours, 10) || 0;
  const m = parseInt(minutes, 10) || 0;
  const duration = (h * 3600 + m * 60) * 1000;
  if (duration <= 0) return;
  const now = Date.now();
  project.entries.push({
    id: now,
    start: now - duration,
    end: now,
    duration,
    manual: true
  });
  save();
  render();
}

function deleteEntry(projectId, entryId) {
  const project = state.projects.find(p => p.id === projectId);
  if (!project) return;
  project.entries = project.entries.filter(e => e.id !== entryId);
  save();
  render();
}

function deleteProject(projectId) {
  state.projects = state.projects.filter(p => p.id !== projectId);
  save();
  render();
}

function addProject(name) {
  if (!name.trim()) return;
  state.projects.push({
    id: Date.now(),
    name: name.trim(),
    entries: [],
    running: false,
    startedAt: null,
    showEntries: false
  });
  save();
  render();
}

function startRename(projectId) {
  const project = state.projects.find(p => p.id === projectId);
  if (!project) return;
  const nameEl = document.getElementById(`name-${projectId}`);
  if (!nameEl) return;
  const dot = project.running ? '<span class="status-dot"></span>' : '';
  nameEl.innerHTML = `${dot}<input class="project-name-input" autocorrect="off" autocapitalize="off" spellcheck="false" value="${project.name.replace(/"/g, '&quot;')}" id="rename-${projectId}" />`;
  const input = document.getElementById(`rename-${projectId}`);
  input.focus();
  input.select();
  const finish = () => {
    const newName = input.value.trim();
    if (newName && newName !== project.name) {
      project.name = newName;
      save();
    }
    render();
  };
  input.addEventListener('blur', finish);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
    if (e.key === 'Escape') { input.value = project.name; input.blur(); }
  });
}

function toggleEntries(projectId) {
  const project = state.projects.find(p => p.id === projectId);
  if (!project) return;
  project.showEntries = !project.showEntries;
  render();
}

function render() {
  const container = document.getElementById('projects');

  // Clear old intervals
  Object.values(timerIntervals).forEach(clearInterval);
  timerIntervals = {};

  if (state.projects.length === 0) {
    container.innerHTML = '<div class="empty-state">žádné projekty — přidej první výše</div>';
    return;
  }

  container.innerHTML = state.projects.map(project => {
    const total = totalTime(project);
    const session = currentSessionTime(project);

    const entriesHtml = project.showEntries ? `
      <div class="entries-list">
        ${project.entries.length === 0 ? '<div class="entry">žádné záznamy</div>' :
          project.entries.map(e => `
            <div class="entry">
              <span>${e.manual ? 'ruční' : new Date(e.start).toLocaleString('cs-CZ', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' })} — ${formatDuration(e.duration)}</span>
              <span class="entry-time">${formatDuration(e.duration)}</span>
              <button class="btn btn--small btn--red" onclick="deleteEntry(${project.id}, ${e.id})">×</button>
            </div>
          `).join('')
        }
        <div class="manual-form">
          <label>+</label>
          <input type="number" id="manual-h-${project.id}" placeholder="h" min="0" max="99" autocorrect="off" autocapitalize="off" />
          <label>:</label>
          <input type="number" id="manual-m-${project.id}" placeholder="m" min="0" max="59" autocorrect="off" autocapitalize="off" />
          <button class="btn btn--small" onclick="addManualEntry(${project.id}, document.getElementById('manual-h-${project.id}').value, document.getElementById('manual-m-${project.id}').value)">přidat</button>
        </div>
      </div>
    ` : '';

    return `
      <div class="project ${project.running ? 'project--active' : ''}">
        <div class="project-header">
          <div class="project-name" id="name-${project.id}" onclick="startRename(${project.id})">
            ${project.running ? '<span class="status-dot"></span>' : ''}${project.name}
          </div>
          <div class="project-controls">
            <button class="btn btn--small btn--red" onclick="if(confirm('Smazat projekt?')) deleteProject(${project.id})">smazat</button>
          </div>
        </div>
        <div class="project-timer">
          <div class="timer-display" id="timer-${project.id}">${project.running ? formatDuration(session) : '00:00:00'}</div>
          <div class="timer-total">celkem: <span id="total-${project.id}">${formatDuration(total)}</span></div>
        </div>
        <div class="project-actions">
          ${project.running
            ? `<button class="btn btn--red" onclick="stopTimer(${project.id})">■ stop</button>`
            : `<button class="btn btn--accent" onclick="startTimer(${project.id})">▶ start</button>`
          }
          <button class="btn" onclick="toggleEntries(${project.id})">${project.showEntries ? '▲ skrýt' : '▼ záznamy'}</button>
        </div>
        ${project.showEntries ? `<div class="entries">${entriesHtml}</div>` : ''}
      </div>
    `;
  }).join('');

  // Start live timers for running projects
  state.projects.filter(p => p.running).forEach(project => {
    timerIntervals[project.id] = setInterval(() => {
      const timerEl = document.getElementById(`timer-${project.id}`);
      const totalEl = document.getElementById(`total-${project.id}`);
      if (timerEl) timerEl.textContent = formatDuration(currentSessionTime(project));
      if (totalEl) totalEl.textContent = formatDuration(totalTime(project));
    }, 200);
  });
}

// Backup
function exportData() {
  const json = JSON.stringify(state, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const date = new Date().toISOString().slice(0, 10);
  a.download = `zachytavac-${date}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importData(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const imported = JSON.parse(e.target.result);
      if (!imported.projects || !Array.isArray(imported.projects)) {
        alert('Neplatný soubor');
        return;
      }
      if (!confirm(`Import ${imported.projects.length} projektů? Přepíše aktuální data.`)) return;
      state = imported;
      save();
      render();
    } catch { alert('Chyba při čtení souboru'); }
  };
  reader.readAsText(file);
  input.value = '';
}

// Form handler
document.getElementById('new-project-form').addEventListener('submit', e => {
  e.preventDefault();
  const input = document.getElementById('project-name-input');
  addProject(input.value);
  input.value = '';
});

// Initial render
render();
</script>

</body>
</html>
